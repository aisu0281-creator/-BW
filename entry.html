<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>大会エントリー</title>
</head>
<body>

<h2>現在の参加人数：<span id="count">0</span>人</h2>

<h3>エントリーフォーム</h3>
<form id="form" onsubmit="sendEntry(event)">
    名前：<input id="name" required><br><br>
    ゲームID：<input id="gameid" required><br><br>
    Discord：<input id="discord" required><br><br>
    コメント：<input id="comment"><br><br>
    <button type="submit">エントリー</button>
</form>

<h3>参加者一覧</h3>
<table border="1">
<thead>
<tr>
<th>名前</th>
<th>ゲームID</th>
<th>Discord</th>
<th>コメント</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<script>
const sheetURL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTHixiOhC6gzmJ3AEKZcCLpViLYrHVnmhYVWcx7jFE2vFPumU2JlYxeOTaK961qDY-pIZ0astOepA7-/pub?output=csv";

const formURL =
"https://docs.google.com/forms/d/e/1FAIpQLSc7UaaqyKeuFvl8aKLzBthW9TH4SFIpds0GsrUiDRKcf3G97g/formResponse";

const entryName = "entry.515437798";
const entryGame = "entry.387215603";
const entryDiscord = "entry.1564981895";
const entryComment = "entry.1417704571";

async function fetchData(){
    const res = await fetch(sheetURL);
    const text = await res.text();
    const rows = text.trim().split("\n");

    // 人数更新
    document.getElementById("count").textContent = rows.length - 1;

    // 一覧更新
    const tbody = document.getElementById("list");
    tbody.innerHTML = "";

    rows.slice(1).reverse().forEach(row=>{
        const cols = row.split(",");
        const tr = document.createElement("tr");

        cols.forEach(col=>{
            const td = document.createElement("td");
            td.textContent = col.replace(/"/g,"");
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
}

async function sendEntry(e){
    e.preventDefault();

    const data = new FormData();
    data.append(entryName, document.getElementById("name").value);
    data.append(entryGame, document.getElementById("gameid").value);
    data.append(entryDiscord, document.getElementById("discord").value);
    data.append(entryComment, document.getElementById("comment").value);

    await fetch(formURL,{
        method:"POST",
        mode:"no-cors",
        body:data
    });

    alert("エントリー完了！");
    document.getElementById("form").reset();
    setTimeout(fetchData,1500);
}

window.onload = fetchData;
setInterval(fetchData,5000);
</script>

</body>
</html>
